!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("karet.lift"),require("infestines"),require("kefir"),require("kefir.partial.lenses")):"function"==typeof define&&define.amd?define(["exports","karet.lift","infestines","kefir","kefir.partial.lenses","partial.lenses.validation"],t):t((e.karet=e.karet||{},e.karet.xhr={}),e.karet.lift,e.I,e.Kefir,e.Kefir.partial.lenses)}(this,function(e,t,w,r,H,n){"use strict";function v(e){try{return JSON.parse(e)}catch(e){return null}}var s=function(e){return e instanceof r.Observable},u=function(e){return s(e)?e:r.constant(e)},i=function(e){return e instanceof r.Stream?e.toProperty():e},o=r.never(),a=w.curry(function(e,t){return s(t)?t.skipDuplicates(e):t})(w.acyclicEqualsU),d=w.curry(function(e,t){if(s(t))return t.filter(e);if(e(t))return t;throw Error(e.name)}),p=w.curry(function(e,t){return s(t)?i(t.flatMapLatest(w.pipe2U(e,u))):i(e(t))}),c=function(e){return e.toLowerCase()},f=function(e){return e},S="addEventListener",T="down",l="error",x="event",y="initial",b="json",k="load",O="loadend",g="loadstart",E="overrideMimeType",U="progress",m="readyState",R="responseType",L="status",q="timeout",h="type",M="up",j="withCredentials",C="xhr",F=w.freeze({type:y}),I=w.freeze({type:O}),A=w.freeze({type:k}),P=[g,U,q,k,l],N=function(e){return null==e},X=(0,w.id)(function(h){return r.stream(function(e){var n=e.emit,t=e.end,r=h.url,s=h.method,u=h.user,i=h.password,o=h.headers,a=h[E],d=h.body,p=h[R],c=h[q],f=h[j],l=new XMLHttpRequest,y={xhr:l,up:F,down:F,map:w.id},g=function(t,r){return function(e){r===U&&y[t].type===k||n(y=H.set(t,{type:r,event:e},y))}};for(var m in P.forEach(function(e){l[S](e,g(T,e)),l.upload[S](e,g(M,e))}),l[S]("readystatechange",function(e){n(y=H.set(x,e,y))}),l[S](O,function(e){t(n(y=H.set(x,e,y)))}),l.open(N(s)?"GET":s,r,!0,N(u)?null:u,N(i)?null:i),p&&(l[R]=p)===b&&l[R]!==b&&(y=H.set("map",v,y)),c&&(l[q]=c),f&&(l[j]=f),o)l.setRequestHeader(m,o[m]);return a&&l[E](a),l.send(N(d)?null:d),function(){l[L]||l.abort()}})}),z=H.get([H.array(H.cross([H.reread(c),H.identity])),H.inverse(H.keyed)]),J=(0,w.id)(H.transform(H.ifElse(w.isString,H.modifyOp(function(e){return{url:e,headers:w.object0}}),H.branch({headers:H.cond([N,H.setOp(w.object0)],[w.isArray,H.modifyOp(z)],[function(e){return w.isFunction(e.keys)},H.modifyOp(w.pipe2U(Array.from,z))],[[H.keys,H.modifyOp(c)]])})))),K=f(w.pipe2U(J,p(X))),D=w.curry(function(e,t){return e.includes(t)}),_=w.curry(function(e,t){return H.get([t,h,D(e)])}),G=_(P),W=_([U,g]),B=_([k]),Q=_([l]),V=_([q]),Y=_([k,l,q]),Z=w.curry(function(e,t,r){return t([r,x,e])}),$=Z("loaded",H.sum),ee=Z("total",H.sum),te=Z(l),re=function(e){return 200<=e&&e<300},ne=w.curryN(3,function(e,t){return w.pipe2U(d(e),t)}),se=H.branches(T,M),ue=f(G(M)),ie=f(W(M)),oe=f(B(M)),ae=f(Q(M)),de=f(V(M)),pe=f(Y(M)),ce=f($(M)),fe=f(ee(M)),le=f(te(H.get,M)),ye=f(G(T)),ge=f(W(T)),me=f(B(T)),he=f(Q(T)),we=f(V(T)),He=f(Y(T)),ve=f($(T)),Se=f(ee(T)),Te=f(te(H.get,T)),xe=f(H.get([C,m])),be=f(H.get([C,m,function(e){return 2<=e}])),ke=f(_([O],x)),Oe=f(W(se)),Ee=f(Q(se)),Ue=f(V(se)),Re=f($(se)),Le=f(ee(se)),qe=f(w.pipe2U(te(H.collect,se),a)),Me=f(ne(me,w.pipe2U(t.lift(function(e){return(0,e.map)(e.xhr.response)}),a))),je=f(H.get([C,R])),Ce=f(ne(be,H.get([C,"responseURL"]))),Fe=f(H.get([C,H.when(H.get([R,D(["","text"])])),"responseText"])),Ie=f(ne(me,H.get([C,H.when(H.get([R,D(["","document"])])),"responseXML"]))),Ae=f(ne(be,H.get([C,L]))),Pe=f(H.get([C,L,re])),Ne=f(ne(be,H.get([C,"statusText"]))),Xe=w.curryN(2,function(t){return ne(be,H.get([C,H.reread(function(e){return e.getResponseHeader(t)})]))}),ze=f(ne(be,H.get([C,H.reread(function(e){return e.getAllResponseHeaders()})]))),Je=f(H.get([C,q])),Ke=f(H.get([C,j])),De=t.lift(re),_e=t.lift(function(e,t){var r=w.assign({},e.headers,t.headers);return w.assign({},e,t,{headers:r})}),Ge=w.curry(function(e,t){return K(_e(J(e),J(t)))}),We=f(Ge({responseType:b,headers:{"Content-Type":"application/json"}})),Be=[h,D([y,k])],Qe=f(H.and(H.branch({event:[h,H.is(O)],up:Be,down:Be,xhr:[L,re]}))),Ve=f(w.pipe2U(We,p(function(e){return Qe(e)?Me(e):ke(e)&&(Ee(e)||Ue(e))?r.constantError(e):o}))),Ye=f(ne(Qe,Me)),Ze=w.always(""),$e=w.always(null),et=function(e){return{event:I,up:F,down:A,xhr:{getAllResponseHeaders:Ze,getResponseHeader:$e,readyState:4,response:e,status:200,statusText:"OK"},map:w.id}},tt=w.curry(function(t,e){return p(function(e){return Qe(e)?t(Me(e)):e},e)}),rt=w.curry(function(e,t){return tt(w.pipe2U(e,et),t)}),nt=w.curry(function(e,t){return tt(function(e){return rt(e,t)},e)}),st=w.Monad(rt,et,nt,tt),ut=[h,w.isString],it=f(H.and(H.branch({xhr:[m,w.isNumber],up:ut,down:ut,map:w.isFunction}))),ot=w.IdentityOrU(it,st),at=f(H.get([H.traverse(ot,w.id,t.inTemplate(it)),H.ifElse(it,[],et)])),dt=w.curry(function(t,e){return rt(function(e){return t.apply(null,e)},at(e))}),pt=function(e){return e},ct=pt(me),ft=pt(be),lt=pt(Me),yt=pt(oe);e.perform=K,e.upHasStarted=ue,e.upIsProgressing=ie,e.upHasCompleted=oe,e.upHasFailed=ae,e.upHasTimedOut=de,e.upHasEnded=pe,e.upLoaded=ce,e.upTotal=fe,e.upError=le,e.downHasStarted=ye,e.downIsProgressing=ge,e.downHasCompleted=me,e.downHasFailed=he,e.downHasTimedOut=we,e.downHasEnded=He,e.downLoaded=ve,e.downTotal=Se,e.downError=Te,e.readyState=xe,e.isStatusAvailable=be,e.isDone=ke,e.isProgressing=Oe,e.hasFailed=Ee,e.hasTimedOut=Ue,e.loaded=Re,e.total=Le,e.errors=qe,e.response=Me,e.responseType=je,e.responseURL=Ce,e.responseText=Fe,e.responseXML=Ie,e.status=Ae,e.statusIsHttpSuccess=Pe,e.statusText=Ne,e.responseHeader=Xe,e.allResponseHeaders=ze,e.timeout=Je,e.withCredentials=Ke,e.isHttpSuccess=De,e.performWith=Ge,e.performJson=We,e.hasSucceeded=Qe,e.getJson=Ve,e.result=Ye,e.of=et,e.chain=tt,e.map=rt,e.ap=nt,e.Succeeded=st,e.isXHR=it,e.IdentitySucceeded=ot,e.template=at,e.apply=dt,e.downHasSucceeded=ct,e.headersReceived=ft,e.responseFull=lt,e.upHasSucceeded=yt,Object.defineProperty(e,"__esModule",{value:!0})});
