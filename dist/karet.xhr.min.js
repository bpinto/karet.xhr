!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("karet.lift"),require("infestines"),require("kefir"),require("kefir.partial.lenses")):"function"==typeof define&&define.amd?define(["exports","karet.lift","infestines","kefir","kefir.partial.lenses","partial.lenses.validation"],r):r((e.karet=e.karet||{},e.karet.xhr={}),e.karet.lift,e.I,e.Kefir,e.Kefir.partial.lenses)}(this,function(e,r,n,t,w,s){"use strict";function o(e){var r=P(e);return(i(r)?r.flatMapLatest(M):M(r)).toProperty()}var i=function(e){return e instanceof t.Observable},u=n.curry(function(e,r){return i(r)?r.skipDuplicates(e):r})(n.acyclicEqualsU),a=n.curry(function(e,r){if(i(r))return r.filter(e);if(e(r))return r;throw Error(e.name)}),d=function(e){return e.toLowerCase()},p=function(e){return e},H="addEventListener",v="down",c="error",T="event",f="initial",k="json",l="load",x="loadend",y="loadstart",b="overrideMimeType",g="progress",h="readyState",S="responseType",E="status",L="timeout",m="type",O="up",R="withCredentials",U="xhr",q={type:f},j=[y,g,L,l,c],C=function(e){return null==e},M=(0,n.id)(function(m){return t.stream(function(e){var n=e.emit,r=e.end,t=m.url,s=m.method,o=m.user,i=m.password,u=m.headers,a=m[b],d=m.body,p=m[S],c=m[L],f=m[R],l=new XMLHttpRequest,y={xhr:l,up:q,down:q},g=function(r,t){return function(e){n(y=w.set(r,{type:t,event:e},y))}};for(var h in j.forEach(function(e){l[H](e,g(v,e)),l.upload[H](e,g(O,e))}),l[H]("readystatechange",function(e){n(y=w.set(T,e,y))}),l[H](x,function(e){r(n(y=w.set(T,e,y)))}),l.open(C(s)?"GET":s,t,!0,C(o)?null:o,C(i)?null:i),p&&(l[S]=p)===k&&l[S]!==k&&(y=w.set("parse",!0,y)),c&&(l[L]=c),f&&(l[R]=f),u)l.setRequestHeader(h,u[h]);return a&&l[b](a),l.send(C(d)?null:d),function(){l[E]||l.abort()}})}),F=w.get([w.array(w.cross([w.reread(d),w.identity])),w.inverse(w.keyed)]),P=(0,n.id)(w.transform(w.ifElse(n.isString,w.modifyOp(function(e){return{url:e,headers:n.object0}}),w.branch({headers:w.cond([C,w.setOp(n.object0)],[n.isArray,w.modifyOp(F)],[function(e){return n.isFunction(e.keys)},w.modifyOp(n.pipe2U(Array.from,F))],[[w.keys,w.modifyOp(d)]])})))),A=n.curry(function(e,r){return e.includes(r)}),I=n.curry(function(e,r){return w.get([r,m,A(e)])}),X=I(j),D=I([g,y]),J=I([l]),K=I([c]),N=I([L]),_=I([l,c,L]),G=n.curry(function(e,r,t){return r([t,T,e])}),W=G("loaded",w.sum),z=G("total",w.sum),B=G(c),Q=function(e){return 200<=e&&e<300},V=n.curryN(3,function(e,r){return n.pipe2U(a(e),r)}),Y=w.branches(v,O),Z=p(X(O)),$=p(D(O)),ee=p(J(O)),re=p(K(O)),te=p(N(O)),ne=p(_(O)),se=p(W(O)),oe=p(z(O)),ie=p(B(w.get,O)),ue=p(X(v)),ae=p(D(v)),de=p(J(v)),pe=p(K(v)),ce=p(N(v)),fe=p(_(v)),le=p(W(v)),ye=p(z(v)),ge=p(B(w.get,v)),he=p(w.get([U,h])),me=p(w.get([U,h,function(e){return 2<=e}])),we=p(I([x],T)),He=p(D(Y)),ve=p(K(Y)),Te=p(N(Y)),ke=p(W(Y)),xe=p(z(Y)),be=p(n.pipe2U(B(w.collect,Y),u)),Se=p(n.pipe2U(r.lift(function(e){var r=e.xhr.response;return e.parse?function(e){try{return k.parse(e)}catch(e){return null}}(r):r}),u)),Ee=p(V(we,Se)),Le=p(w.get([U,S])),Oe=p(V(me,w.get([U,"responseURL"]))),Re=p(w.get([U,w.when(w.get([S,A(["","text"])])),"responseText"])),Ue=p(V(we,w.get([U,w.when(w.get([S,A(["","document"])])),"responseXML"]))),qe=p(V(me,w.get([U,E]))),je=p(w.get([U,E,Q])),Ce=p(V(me,w.get([U,"statusText"]))),Me=n.curryN(2,function(r){return V(me,w.get([U,w.reread(function(e){return e.getResponseHeader(r)})]))}),Fe=p(V(me,w.get([U,w.reread(function(e){return e.getAllResponseHeaders()})]))),Pe=p(w.get([U,L])),Ae=p(w.get([U,R])),Ie=r.lift(Q),Xe=r.lift(function(e,r){var t=n.assign({},e.headers,r.headers);return n.assign({},e,r,{headers:t})}),De=n.curry(function(e,r){return o(Xe(P(e),P(r)))}),Je=p(De({responseType:k,headers:{"Content-Type":"application/json"}})),Ke=p(n.pipe2U(Je,Ee)),Ne=[m,A([f,l])],_e=p(w.and(w.branch({event:[m,w.is(x)],up:Ne,down:Ne,xhr:[E,Q]}))),Ge=function(e){return e},We=Ge(de),ze=Ge(me),Be=Ge(ee);e.perform=o,e.upHasStarted=Z,e.upIsProgressing=$,e.upHasCompleted=ee,e.upHasFailed=re,e.upHasTimedOut=te,e.upHasEnded=ne,e.upLoaded=se,e.upTotal=oe,e.upError=ie,e.downHasStarted=ue,e.downIsProgressing=ae,e.downHasCompleted=de,e.downHasFailed=pe,e.downHasTimedOut=ce,e.downHasEnded=fe,e.downLoaded=le,e.downTotal=ye,e.downError=ge,e.readyState=he,e.isStatusAvailable=me,e.isDone=we,e.isProgressing=He,e.hasFailed=ve,e.hasTimedOut=Te,e.loaded=ke,e.total=xe,e.errors=be,e.response=Se,e.responseFull=Ee,e.responseType=Le,e.responseURL=Oe,e.responseText=Re,e.responseXML=Ue,e.status=qe,e.statusIsHttpSuccess=je,e.statusText=Ce,e.responseHeader=Me,e.allResponseHeaders=Fe,e.timeout=Pe,e.withCredentials=Ae,e.isHttpSuccess=Ie,e.performWith=De,e.performJson=Je,e.getJson=Ke,e.hasSucceeded=_e,e.downHasSucceeded=We,e.headersReceived=ze,e.upHasSucceeded=Be,Object.defineProperty(e,"__esModule",{value:!0})});
