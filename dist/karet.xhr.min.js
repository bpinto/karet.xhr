!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("karet.lift"),require("infestines"),require("kefir"),require("kefir.partial.lenses")):"function"==typeof define&&define.amd?define(["exports","karet.lift","infestines","kefir","kefir.partial.lenses","partial.lenses.validation"],r):r((e.karet=e.karet||{},e.karet.xhr={}),e.karet.lift,e.I,e.Kefir,e.Kefir.partial.lenses)}(this,function(e,r,n,o,h,t){"use strict";function s(e){var r=y(e);return(i(r)?r.flatMapLatest(c):c(r)).toProperty()}var i=function(e){return e instanceof o.Observable},a=n.curry(function(e,r){return i(r)?r.skipDuplicates(e):r}),u=n.curry(function(e,r){if(i(r))return r.filter(e);if(e(r))return r;throw Error(e.name)}),d=function(e){return e.toLowerCase()},p=function(e){return e},v={type:"initial"},w=["loadstart","progress","timeout","load","error"],f="xhr",T="up",H="down",k="event",c=(0,n.id)(function(e){var a=e.url,r=e.method,u=void 0===r?"GET":r,t=e.user,d=void 0===t?null:t,n=e.password,p=void 0===n?null:n,f=e.headers,c=e.overrideMimeType,s=e.body,l=void 0===s?null:s,y=e.responseType,g=e.timeout,m=e.withCredentials;return o.stream(function(e){var n=e.emit,r=e.end,t=new XMLHttpRequest,s={xhr:t,up:v,down:v},o=function(r,t){return function(e){n(s=h.set(r,{type:t,event:e},s))}};for(var i in w.forEach(function(e){t.addEventListener(e,o(H,e)),t.upload.addEventListener(e,o(T,e))}),t.addEventListener("readystatechange",function(e){n(s=h.set(k,e,s))}),t.addEventListener("loadend",function(e){r(n(s=h.set(k,e,s)))}),t.open(u,a,!0,d,p),y&&"json"===(t.responseType=y)&&"json"!==t.responseType&&(s=h.set("parse",!0,s)),g&&(t.timeout=g),m&&(t.withCredentials=m),f)t.setRequestHeader(i,f[i]);return c&&t.overrideMimeType(c),t.send(l),function(){t.status||t.abort()}})}),l=h.get([h.array(h.cross([h.reread(d),h.identity])),h.inverse(h.keyed)]),y=(0,n.id)(h.transform(h.ifElse(n.isString,h.modifyOp(function(e){return{url:e,headers:n.object0}}),h.branch({headers:h.cond([function(e){return null==e},h.setOp(n.object0)],[n.isArray,h.modifyOp(l)],[function(e){return n.isFunction(e.keys)},h.modifyOp(n.pipe2U(Array.from,l))],[[h.keys,h.modifyOp(d)]])})))),g=n.curry(function(e,r){return e.includes(r)}),m=n.curry(function(e,r){return h.get([r,"type",g(e)])}),E=m(w),L=m(["progress","loadstart"]),x=m(["load"]),S=m(["error"]),O=m(["timeout"]),b=m(["load","error","timeout"]),R=n.curry(function(e,r){return h.get([r,k,e])}),U=R("loaded"),j=R("total"),q=R("error"),M=function(e){return 200<=e&&e<300},C=n.curryN(3,function(e,r){return n.pipe2U(u(e),r)}),N=p(E(T)),P=p(L(T)),F=p(x(T)),I=p(S(T)),A=p(O(T)),D=p(b(T)),J=p(U(T)),X=p(j(T)),K=p(q(T)),_=p(E(H)),G=p(L(H)),W=p(x(H)),z=p(S(H)),B=p(O(H)),Q=p(b(H)),V=p(U(H)),Y=p(j(H)),Z=p(q(H)),$=p(h.get([f,"readyState"])),ee=n.defineNameU(h.get([f,"readyState",function(e){return 2<=e}]),"headersReceived"),re=n.defineNameU(h.get([k,"type",h.is("loadend")]),"isDone"),te=p(h.get([k,"type",h.is("readystatechange")])),ne=p(n.pipe2U(r.lift(function(e){var r=e.xhr.response;return e.parse?function(e){try{return JSON.parse(e)}catch(e){return null}}(r):r}),a(n.acyclicEqualsU))),se=p(C(re,ne)),oe=p(h.get([f,"responseType"])),ie=p(h.get([f,"responseURL"])),ae=p(h.get([f,h.when(h.get(["responseType",g(["","text"])])),"responseText"])),ue=C(re,p(h.get([f,h.when(h.get(["responseType",g(["","document"])])),"responseXML"]))),de=p(h.get([f,"status"])),pe=p(h.get([f,"status",M])),fe=p(h.get([f,"statusText"])),ce=n.curryN(2,function(r){return C(ee,p(h.get([f,h.reread(function(e){return e.getResponseHeader(r)})])))}),le=C(ee,p(h.get([f,h.reread(function(e){return e.getAllResponseHeaders()})]))),ye=p(h.get([f,"timeout"])),ge=p(h.get([f,"withCredentials"])),me=r.lift(M),he=r.lift(function(e,r){var t=n.assign({},e.headers,r.headers);return n.assign({},e,r,{headers:t})}),ve=n.curry(function(e,r){return s(he(y(e),y(r)))}),we=p(ve({responseType:"json",headers:{"Content-Type":"application/json"}})),Te=p(n.pipe2U(we,se));e.perform=s,e.upHasStarted=N,e.upIsProgressing=P,e.upHasSucceeded=F,e.upHasFailed=I,e.upHasTimedOut=A,e.upHasEnded=D,e.upLoaded=J,e.upTotal=X,e.upError=K,e.downHasStarted=_,e.downIsProgressing=G,e.downHasSucceeded=W,e.downHasFailed=z,e.downHasTimedOut=B,e.downHasEnded=Q,e.downLoaded=V,e.downTotal=Y,e.downError=Z,e.readyState=$,e.headersReceived=ee,e.isDone=re,e.isProgressing=te,e.response=ne,e.responseFull=se,e.responseType=oe,e.responseURL=ie,e.responseText=ae,e.responseXML=ue,e.status=de,e.statusIsHttpSuccess=pe,e.statusText=fe,e.responseHeader=ce,e.allResponseHeaders=le,e.timeout=ye,e.withCredentials=ge,e.isHttpSuccess=me,e.performWith=ve,e.performJson=we,e.getJson=Te,Object.defineProperty(e,"__esModule",{value:!0})});
