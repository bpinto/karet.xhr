!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("karet.lift"),require("infestines"),require("kefir"),require("kefir.partial.lenses")):"function"==typeof define&&define.amd?define(["exports","karet.lift","infestines","kefir","kefir.partial.lenses","partial.lenses.validation"],t):t(((e=e||self).karet=e.karet||{},e.karet.xhr={}),e.karet.lift,e.I,e.Kefir,e.Kefir.partial.lenses)}(this,function(e,t,v,r,w,n){"use strict";function H(e){try{return JSON.parse(e)}catch(e){return null}}var u="value",i=v.inherit(function(e){r.Property.call(this),this.s=e,this.h=this.t=0},r.Property,{_onActivation:function(){var r=this;r.t?(clearTimeout(r.t),r.t=0):r.s.onAny(r.h=function(e){var t=e.type;t===u?r._emitValue(e[u]):"end"===t?r._emitEnd():r._emitError(e[u])})},_onDeactivation:function(){var e=this;e.t=setTimeout(function(){e.s.offAny(e.h),e.h=e.t=0},0)}}),o=function(e){return e instanceof r.Observable},s=function(e){return o(e)?e:r.constant(e)},a=function(e){return e instanceof r.Stream?e.toProperty():e},c=r.never(),d=v.curry(function(e,t){return o(t)?t.skipDuplicates(e):t})(v.acyclicEqualsU),p=v.curry(function(e,t){if(o(t))return t.filter(e);if(e(t))return t;throw Error(e.name)}),f=v.curry(function(e,t){return o(t)?a(t.flatMapLatest(v.pipe2U(e,s))):a(e(t))}),l=v.curry(function(e,t){return o(t)?a(t.map(e)):e(t)}),y=function(e){return e.toLowerCase()},h=function(e){return e},x="addEventListener",T="down",m="error",E="event",g="initial",O="json",S="load",b="loaded",k="loadend",U="loadstart",L="overrideMimeType",P="progress",R="readyState",A="responseType",I="status",q="timeout",M="total",N="type",_="up",j="withCredentials",C="xhr",F=v.freeze({type:g}),X=v.freeze({type:k}),z=v.freeze({type:S}),D=[U,P,S,q,m],J=function(e){return null==e},K=(0,v.id)(function(g){return e=r.stream(function(e){var n=e.emit,t=e.end,r=g.url,u=g.method,i=g.user,o=g.password,s=g.headers,a=g[L],c=g.body,d=g[A],p=g[q],f=g[j],l=new XMLHttpRequest,y={xhr:l,up:F,down:F,map:v.id},h=function(t,r){return function(e){r===P&&y[t].type===S||n(y=w.set(t,{type:r,event:e},y))}};for(var m in D.forEach(function(e){l[x](e,h(T,e)),l.upload[x](e,h(_,e))}),l[x]("readystatechange",function(e){n(y=w.set(E,e,y))}),l[x](k,function(e){t(n(y=w.set(E,e,y)))}),l.open(J(u)?"GET":u,r,!0,J(i)?null:i,J(o)?null:o),d&&(l[A]=d)===O&&l[A]!==O&&(y=w.set("map",H,y)),p&&(l[q]=p),f&&(l[j]=f),s)l.setRequestHeader(m,s[m]);return a&&l[L](a),l.send(J(c)?null:c),function(){l[I]||l.abort()}}),new i(e);var e}),G=w.get([w.array(w.cross([w.reread(y),w.identity])),w.inverse(w.keyed)]),V=(0,v.id)(w.transform(w.ifElse(v.isString,w.modifyOp(function(e){return{url:e,headers:v.object0}}),w.branch({headers:w.cond([J,w.setOp(v.object0)],[v.isArray,w.modifyOp(G)],[function(e){return v.isFunction(e.keys)},w.modifyOp(v.pipe2U(Array.from,G))],[[w.keys,w.modifyOp(y)]])})))),W=h(v.pipe2U(V,f(K))),B=v.curry(function(e,t){return e.includes(t)}),Q=v.curry(function(e,t){return w.get([t,N,B(e)])}),Y=Q(D),Z=Q([P,U]),$=Q([S]),ee=Q([m]),te=Q([q]),re=Q([S,q,m]),ne=Q([m,q]),ue=v.curry(function(e,t,r){return t([r,E,e])}),ie=ue(b,w.sum),oe=ue(M,w.sum),se=ue(m),ae=function(e){return 200<=e&&e<300},ce=v.curryN(3,function(e,t){return v.pipe2U(p(e),t)}),de=w.branches(T,_),pe=h(Y(_)),fe=h(Z(_)),le=h($(_)),ye=h(ee(_)),he=h(ee(_)),me=h(te(_)),ge=h(re(_)),ve=h(ie(_)),we=h(oe(_)),He=h(se(w.get,_)),xe=h(Y(T)),Te=h(Z(T)),Ee=h($(T)),Oe=h(ne(T)),Se=h(ee(T)),be=h(te(T)),ke=h(re(T)),Ue=h(ie(T)),Le=h(oe(T)),Pe=h(se(w.get,T)),Re=h(w.get([C,R])),Ae=h(w.get([C,R,function(e){return 2<=e}])),Ie=h(Q([k],E)),qe=h(Z(de)),Me=h(ee(de)),Ne=h(te(de)),_e=h(ie(de)),je=h(oe(de)),Ce=h(v.pipe2U(se(w.collect,de),d)),Fe=h(ce(Ee,v.pipe2U(t.lift(function(e){return(0,e.map)(e.xhr.response)}),d))),Xe=h(w.get([C,A])),ze=h(ce(Ae,w.get([C,"responseURL"]))),De=h(w.get([C,w.when(w.get([A,B(["","text"])])),"responseText"])),Je=h(ce(Ee,w.get([C,w.when(w.get([A,B(["","document"])])),"responseXML"]))),Ke=h(ce(Ae,w.get([C,I]))),Ge=h(w.get([C,I,ae])),Ve=h(ce(Ae,w.get([C,"statusText"]))),We=v.curryN(2,function(t){return ce(Ae,w.get([C,w.reread(function(e){return e.getResponseHeader(t)})]))}),Be=h(ce(Ae,w.get([C,w.reread(function(e){return e.getAllResponseHeaders()})]))),Qe=h(w.get([C,q])),Ye=h(w.get([C,j])),Ze=t.lift(ae),$e=t.lift(function(e,t){var r=v.assign({},e.headers,t.headers);return v.assign({},e,t,{headers:r})}),et=v.curry(function(e,t){return W($e(V(e),V(t)))}),tt=h(et({responseType:O,headers:{"Content-Type":"application/json"}})),rt=[N,B([g,S])],nt=h(w.and(w.branch({event:[N,w.is(k)],up:rt,down:rt,xhr:[I,ae]}))),ut=t.lift(function(e){return Ae(e)&&!Ge(e)||Oe(e)||ye(e)}),it=h(v.pipe2U(tt,f(function(e){return nt(e)?Fe(e):Ie(e)&&(Me(e)||Ne(e))?r.constantError(e):c}))),ot=h(ce(nt,Fe)),st=function(e,t){return{type:(r=e[N],n=t[N],D.indexOf(r)<D.indexOf(n)?r:n),event:{total:(w.get(M,e[E])||0)+(w.get(M,t[E])||0),loaded:(w.get(b,e[E])||0)+(w.get(b,t[E])||0)}};var r,n},at=function(e,t){return{event:t[E][N]===k?e[E]:t[E],xhr:t.xhr,up:st(e.up,t.up),down:st(e[T],t[T]),map:t.map}},ct=v.always(""),dt=v.always(null),pt=function(e){return{event:X,up:F,down:z,xhr:{getAllResponseHeaders:ct,getResponseHeader:dt,readyState:4,response:e,status:200,statusText:"OK"},map:v.id}},ft=v.curryN(2,function(e){return f(function(t){return nt(t)?l(function(e){return ut(e)?e:at(t,e)},e(Fe(t))):t})}),lt=v.curryN(2,function(t){return ft(function(e){return pt(t(e))})}),yt=v.curry(function(e,t){return ft(function(e){return lt(e,t)},e)}),ht=v.Monad(lt,pt,yt,ft),mt=v.curry(function(e,r){return f(function(t){return ut(t)?t:l(function(e){return nt(t)?nt(e)?at(at(t,e),pt(Fe(t)(Fe(e)))):ut(e)?e:at(t,e):at(t,e)},r)},e)}),gt=v.Applicative(lt,pt,mt),vt=[N,v.isString],wt=h(w.and(w.branch({xhr:[R,v.isNumber],up:vt,down:vt,map:v.isFunction}))),Ht=v.IdentityOrU(wt,ht),xt=v.IdentityOrU(wt,gt),Tt=h(w.get([w.traverse(xt,v.id,t.inTemplate(wt)),w.ifElse(wt,[],pt)])),Et=v.curry(function(t,e){return lt(function(e){return t.apply(null,e)},Tt(e))}),Ot=v.curryN(2,function(t){return lt(function(e){return t(e),e})});e.perform=W,e.upHasStarted=pe,e.upIsProgressing=fe,e.upHasCompleted=le,e.upHasFailed=ye,e.upHasErrored=he,e.upHasTimedOut=me,e.upHasEnded=ge,e.upLoaded=ve,e.upTotal=we,e.upError=He,e.downHasStarted=xe,e.downIsProgressing=Te,e.downHasCompleted=Ee,e.downHasFailed=Oe,e.downHasErrored=Se,e.downHasTimedOut=be,e.downHasEnded=ke,e.downLoaded=Ue,e.downTotal=Le,e.downError=Pe,e.readyState=Re,e.isStatusAvailable=Ae,e.isDone=Ie,e.isProgressing=qe,e.hasErrored=Me,e.hasTimedOut=Ne,e.loaded=_e,e.total=je,e.errors=Ce,e.response=Fe,e.responseType=Xe,e.responseURL=ze,e.responseText=De,e.responseXML=Je,e.status=Ke,e.statusIsHttpSuccess=Ge,e.statusText=Ve,e.responseHeader=We,e.allResponseHeaders=Be,e.timeout=Qe,e.withCredentials=Ye,e.isHttpSuccess=Ze,e.performWith=et,e.performJson=tt,e.hasSucceeded=nt,e.hasFailed=ut,e.getJson=it,e.result=ot,e.of=pt,e.chain=ft,e.map=lt,e.ap=yt,e.Succeeded=ht,e.apParallel=mt,e.Parallel=gt,e.isXHR=wt,e.IdentitySucceeded=Ht,e.IdentityParallel=xt,e.template=Tt,e.apply=Et,e.tap=Ot,Object.defineProperty(e,"__esModule",{value:!0})});
