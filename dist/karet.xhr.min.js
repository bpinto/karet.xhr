!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("karet.lift"),require("infestines"),require("kefir"),require("kefir.partial.lenses")):"function"==typeof define&&define.amd?define(["exports","karet.lift","infestines","kefir","kefir.partial.lenses","partial.lenses.validation"],r):r((e.karet=e.karet||{},e.karet.xhr={}),e.karet.lift,e.I,e.Kefir,e.Kefir.partial.lenses)}(this,function(e,r,w,t,H,n){"use strict";function v(e){try{return JSON.parse(e)}catch(e){return null}}var s=function(e){return e instanceof t.Observable},u=function(e){return s(e)?e:t.constant(e)},o=function(e){return e instanceof t.Stream?e.toProperty():e},i=t.never(),a=w.curry(function(e,r){return s(r)?r.skipDuplicates(e):r})(w.acyclicEqualsU),d=w.curry(function(e,r){if(s(r))return r.filter(e);if(e(r))return r;throw Error(e.name)}),p=w.curry(function(e,r){return s(r)?o(r.flatMapLatest(w.pipe2U(e,u))):o(e(r))}),c=function(e){return e.toLowerCase()},f=function(e){return e},T="addEventListener",x="down",l="error",S="event",y="initial",k="json",b="load",O="loadend",g="loadstart",E="overrideMimeType",U="progress",m="readyState",L="responseType",R="status",q="timeout",h="type",j="up",C="withCredentials",M="xhr",A=w.freeze({type:y}),F=w.freeze({type:O}),P=w.freeze({type:b}),z=[g,U,q,b,l],I=function(e){return null==e},J=(0,w.id)(function(h){return t.stream(function(e){var n=e.emit,r=e.end,t=h.url,s=h.method,u=h.user,o=h.password,i=h.headers,a=h[E],d=h.body,p=h[L],c=h[q],f=h[C],l=new XMLHttpRequest,y={xhr:l,up:A,down:A,map:w.id},g=function(r,t){return function(e){t===U&&y[r].type===b||n(y=H.set(r,{type:t,event:e},y))}};for(var m in z.forEach(function(e){l[T](e,g(x,e)),l.upload[T](e,g(j,e))}),l[T]("readystatechange",function(e){n(y=H.set(S,e,y))}),l[T](O,function(e){r(n(y=H.set(S,e,y)))}),l.open(I(s)?"GET":s,t,!0,I(u)?null:u,I(o)?null:o),p&&(l[L]=p)===k&&l[L]!==k&&(y=H.set("map",v,y)),c&&(l[q]=c),f&&(l[C]=f),i)l.setRequestHeader(m,i[m]);return a&&l[E](a),l.send(I(d)?null:d),function(){l[R]||l.abort()}})}),K=H.get([H.array(H.cross([H.reread(c),H.identity])),H.inverse(H.keyed)]),N=(0,w.id)(H.transform(H.ifElse(w.isString,H.modifyOp(function(e){return{url:e,headers:w.object0}}),H.branch({headers:H.cond([I,H.setOp(w.object0)],[w.isArray,H.modifyOp(K)],[function(e){return w.isFunction(e.keys)},H.modifyOp(w.pipe2U(Array.from,K))],[[H.keys,H.modifyOp(c)]])})))),X=f(w.pipe2U(N,p(J))),D=w.curry(function(e,r){return e.includes(r)}),_=w.curry(function(e,r){return H.get([r,h,D(e)])}),G=_(z),W=_([U,g]),B=_([b]),Q=_([l]),V=_([q]),Y=_([b,l,q]),Z=w.curry(function(e,r,t){return r([t,S,e])}),$=Z("loaded",H.sum),ee=Z("total",H.sum),re=Z(l),te=function(e){return 200<=e&&e<300},ne=w.curryN(3,function(e,r){return w.pipe2U(d(e),r)}),se=H.branches(x,j),ue=f(G(j)),oe=f(W(j)),ie=f(B(j)),ae=f(Q(j)),de=f(V(j)),pe=f(Y(j)),ce=f($(j)),fe=f(ee(j)),le=f(re(H.get,j)),ye=f(G(x)),ge=f(W(x)),me=f(B(x)),he=f(Q(x)),we=f(V(x)),He=f(Y(x)),ve=f($(x)),Te=f(ee(x)),xe=f(re(H.get,x)),Se=f(H.get([M,m])),ke=f(H.get([M,m,function(e){return 2<=e}])),be=f(_([O],S)),Oe=f(W(se)),Ee=f(Q(se)),Ue=f(V(se)),Le=f($(se)),Re=f(ee(se)),qe=f(w.pipe2U(re(H.collect,se),a)),je=f(ne(me,w.pipe2U(r.lift(function(e){return(0,e.map)(e.xhr.response)}),a))),Ce=f(H.get([M,L])),Me=f(ne(ke,H.get([M,"responseURL"]))),Ae=f(H.get([M,H.when(H.get([L,D(["","text"])])),"responseText"])),Fe=f(ne(me,H.get([M,H.when(H.get([L,D(["","document"])])),"responseXML"]))),Pe=f(ne(ke,H.get([M,R]))),ze=f(H.get([M,R,te])),Ie=f(ne(ke,H.get([M,"statusText"]))),Je=w.curryN(2,function(r){return ne(ke,H.get([M,H.reread(function(e){return e.getResponseHeader(r)})]))}),Ke=f(ne(ke,H.get([M,H.reread(function(e){return e.getAllResponseHeaders()})]))),Ne=f(H.get([M,q])),Xe=f(H.get([M,C])),De=r.lift(te),_e=r.lift(function(e,r){var t=w.assign({},e.headers,r.headers);return w.assign({},e,r,{headers:t})}),Ge=w.curry(function(e,r){return X(_e(N(e),N(r)))}),We=f(Ge({responseType:k,headers:{"Content-Type":"application/json"}})),Be=[h,D([y,b])],Qe=f(H.and(H.branch({event:[h,H.is(O)],up:Be,down:Be,xhr:[R,te]}))),Ve=f(w.pipe2U(We,p(function(e){return Qe(e)?je(e):be(e)&&(Ee(e)||Ue(e))?t.constantError(e):i}))),Ye=f(ne(Qe,je)),Ze=w.always(""),$e=w.always(null),er=function(e){return{event:F,up:A,down:P,xhr:{getAllResponseHeaders:Ze,getResponseHeader:$e,readyState:4,response:e,status:200,statusText:"OK"},map:w.id}},rr=w.curry(function(r,e){return p(function(e){return Qe(e)?r(je(e)):e},e)}),tr=w.curry(function(e,r){return rr(w.pipe2U(e,er),r)}),nr=w.curry(function(e,r){return rr(function(e){return tr(e,r)},e)}),sr=w.freeze({map:tr,ap:nr,of:er,chain:rr}),ur=w.curry(function(r,e){return tr(function(e){return r.apply(null,e)},H.traverse(sr,w.id,H.elemsTotal,e))}),or=function(e){return e},ir=or(me),ar=or(ke),dr=or(je),pr=or(ie);e.perform=X,e.upHasStarted=ue,e.upIsProgressing=oe,e.upHasCompleted=ie,e.upHasFailed=ae,e.upHasTimedOut=de,e.upHasEnded=pe,e.upLoaded=ce,e.upTotal=fe,e.upError=le,e.downHasStarted=ye,e.downIsProgressing=ge,e.downHasCompleted=me,e.downHasFailed=he,e.downHasTimedOut=we,e.downHasEnded=He,e.downLoaded=ve,e.downTotal=Te,e.downError=xe,e.readyState=Se,e.isStatusAvailable=ke,e.isDone=be,e.isProgressing=Oe,e.hasFailed=Ee,e.hasTimedOut=Ue,e.loaded=Le,e.total=Re,e.errors=qe,e.response=je,e.responseType=Ce,e.responseURL=Me,e.responseText=Ae,e.responseXML=Fe,e.status=Pe,e.statusIsHttpSuccess=ze,e.statusText=Ie,e.responseHeader=Je,e.allResponseHeaders=Ke,e.timeout=Ne,e.withCredentials=Xe,e.isHttpSuccess=De,e.performWith=Ge,e.performJson=We,e.hasSucceeded=Qe,e.getJson=Ve,e.result=Ye,e.of=er,e.chain=rr,e.map=tr,e.ap=nr,e.Succeeded=sr,e.apply=ur,e.downHasSucceeded=ir,e.headersReceived=ar,e.responseFull=dr,e.upHasSucceeded=pr,Object.defineProperty(e,"__esModule",{value:!0})});
