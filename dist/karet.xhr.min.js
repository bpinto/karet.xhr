!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("karet.lift"),require("infestines"),require("kefir"),require("kefir.partial.lenses")):"function"==typeof define&&define.amd?define(["exports","karet.lift","infestines","kefir","kefir.partial.lenses","partial.lenses.validation"],r):r((e.karet=e.karet||{},e.karet.xhr={}),e.karet.lift,e.I,e.Kefir,e.Kefir.partial.lenses)}(this,function(e,r,n,t,w,s){"use strict";var o=function(e){return e instanceof t.Observable},i=t.never(),u=n.curry(function(e,r){return o(r)?r.skipDuplicates(e):r})(n.acyclicEqualsU),a=n.curry(function(e,r){if(o(r))return r.filter(e);if(e(r))return r;throw Error(e.name)}),d=n.curry(function(e,r){return(o(r)?r.flatMapLatest(e):e(r)).toProperty()}),p=function(e){return e.toLowerCase()},c=function(e){return e},H="addEventListener",v="down",f="error",T="event",l="initial",k="json",x="load",b="loadend",y="loadstart",S="overrideMimeType",E="progress",g="readyState",O="responseType",L="status",U="timeout",h="type",R="up",q="withCredentials",m="xhr",j={type:l},C=[y,E,U,x,f],M=function(e){return null==e},F=(0,n.id)(function(m){return t.stream(function(e){var n=e.emit,r=e.end,t=m.url,s=m.method,o=m.user,i=m.password,u=m.headers,a=m[S],d=m.body,p=m[O],c=m[U],f=m[q],l=new XMLHttpRequest,y={xhr:l,up:j,down:j},g=function(r,t){return function(e){t===E&&y[r].type===x||n(y=w.set(r,{type:t,event:e},y))}};for(var h in C.forEach(function(e){l[H](e,g(v,e)),l.upload[H](e,g(R,e))}),l[H]("readystatechange",function(e){n(y=w.set(T,e,y))}),l[H](b,function(e){r(n(y=w.set(T,e,y)))}),l.open(M(s)?"GET":s,t,!0,M(o)?null:o,M(i)?null:i),p&&(l[O]=p)===k&&l[O]!==k&&(y=w.set("parse",!0,y)),c&&(l[U]=c),f&&(l[q]=f),u)l.setRequestHeader(h,u[h]);return a&&l[S](a),l.send(M(d)?null:d),function(){l[L]||l.abort()}})}),P=w.get([w.array(w.cross([w.reread(p),w.identity])),w.inverse(w.keyed)]),A=(0,n.id)(w.transform(w.ifElse(n.isString,w.modifyOp(function(e){return{url:e,headers:n.object0}}),w.branch({headers:w.cond([M,w.setOp(n.object0)],[n.isArray,w.modifyOp(P)],[function(e){return n.isFunction(e.keys)},w.modifyOp(n.pipe2U(Array.from,P))],[[w.keys,w.modifyOp(p)]])})))),I=c(n.pipe2U(A,d(F))),J=n.curry(function(e,r){return e.includes(r)}),N=n.curry(function(e,r){return w.get([r,h,J(e)])}),X=N(C),D=N([E,y]),K=N([x]),_=N([f]),G=N([U]),W=N([x,f,U]),z=n.curry(function(e,r,t){return r([t,T,e])}),B=z("loaded",w.sum),Q=z("total",w.sum),V=z(f),Y=function(e){return 200<=e&&e<300},Z=n.curryN(3,function(e,r){return n.pipe2U(a(e),r)}),$=w.branches(v,R),ee=c(X(R)),re=c(D(R)),te=c(K(R)),ne=c(_(R)),se=c(G(R)),oe=c(W(R)),ie=c(B(R)),ue=c(Q(R)),ae=c(V(w.get,R)),de=c(X(v)),pe=c(D(v)),ce=c(K(v)),fe=c(_(v)),le=c(G(v)),ye=c(W(v)),ge=c(B(v)),he=c(Q(v)),me=c(V(w.get,v)),we=c(w.get([m,g])),He=c(w.get([m,g,function(e){return 2<=e}])),ve=c(N([b],T)),Te=c(D($)),ke=c(_($)),xe=c(G($)),be=c(B($)),Se=c(Q($)),Ee=c(n.pipe2U(V(w.collect,$),u)),Oe=c(Z(ce,n.pipe2U(r.lift(function(e){var r=e.xhr.response;return e.parse?function(e){try{return JSON.parse(e)}catch(e){return null}}(r):r}),u))),Le=c(w.get([m,O])),Ue=c(Z(He,w.get([m,"responseURL"]))),Re=c(w.get([m,w.when(w.get([O,J(["","text"])])),"responseText"])),qe=c(Z(ce,w.get([m,w.when(w.get([O,J(["","document"])])),"responseXML"]))),je=c(Z(He,w.get([m,L]))),Ce=c(w.get([m,L,Y])),Me=c(Z(He,w.get([m,"statusText"]))),Fe=n.curryN(2,function(r){return Z(He,w.get([m,w.reread(function(e){return e.getResponseHeader(r)})]))}),Pe=c(Z(He,w.get([m,w.reread(function(e){return e.getAllResponseHeaders()})]))),Ae=c(w.get([m,U])),Ie=c(w.get([m,q])),Je=r.lift(Y),Ne=r.lift(function(e,r){var t=n.assign({},e.headers,r.headers);return n.assign({},e,r,{headers:t})}),Xe=n.curry(function(e,r){return I(Ne(A(e),A(r)))}),De=c(Xe({responseType:k,headers:{"Content-Type":"application/json"}})),Ke=[h,J([l,x])],_e=c(w.and(w.branch({event:[h,w.is(b)],up:Ke,down:Ke,xhr:[L,Y]}))),Ge=c(n.pipe2U(De,d(function(e){return _e(e)?t.constant(Oe(e)):ve(e)&&(ke(e)||xe(e))?t.constantError(e):i}))),We=function(e){return e},ze=We(ce),Be=We(He),Qe=We(Oe),Ve=We(te);e.perform=I,e.upHasStarted=ee,e.upIsProgressing=re,e.upHasCompleted=te,e.upHasFailed=ne,e.upHasTimedOut=se,e.upHasEnded=oe,e.upLoaded=ie,e.upTotal=ue,e.upError=ae,e.downHasStarted=de,e.downIsProgressing=pe,e.downHasCompleted=ce,e.downHasFailed=fe,e.downHasTimedOut=le,e.downHasEnded=ye,e.downLoaded=ge,e.downTotal=he,e.downError=me,e.readyState=we,e.isStatusAvailable=He,e.isDone=ve,e.isProgressing=Te,e.hasFailed=ke,e.hasTimedOut=xe,e.loaded=be,e.total=Se,e.errors=Ee,e.response=Oe,e.responseType=Le,e.responseURL=Ue,e.responseText=Re,e.responseXML=qe,e.status=je,e.statusIsHttpSuccess=Ce,e.statusText=Me,e.responseHeader=Fe,e.allResponseHeaders=Pe,e.timeout=Ae,e.withCredentials=Ie,e.isHttpSuccess=Je,e.performWith=Xe,e.performJson=De,e.hasSucceeded=_e,e.getJson=Ge,e.downHasSucceeded=ze,e.headersReceived=Be,e.responseFull=Qe,e.upHasSucceeded=Ve,Object.defineProperty(e,"__esModule",{value:!0})});
