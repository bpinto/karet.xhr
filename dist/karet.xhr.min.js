!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("karet.lift"),require("infestines"),require("kefir"),require("kefir.partial.lenses")):"function"==typeof define&&define.amd?define(["exports","karet.lift","infestines","kefir","kefir.partial.lenses","partial.lenses.validation"],r):r((e.karet=e.karet||{},e.karet.xhr={}),e.karet.lift,e.I,e.Kefir,e.Kefir.partial.lenses)}(this,function(e,r,n,t,w,s){"use strict";var o=function(e){return e instanceof t.Observable},i=t.never(),u=n.curry(function(e,r){return o(r)?r.skipDuplicates(e):r})(n.acyclicEqualsU),a=n.curry(function(e,r){if(o(r))return r.filter(e);if(e(r))return r;throw Error(e.name)}),d=n.curry(function(e,r){return(o(r)?r.flatMapLatest(e):e(r)).toProperty()}),p=function(e){return e.toLowerCase()},c=function(e){return e},H="addEventListener",v="down",f="error",T="event",l="initial",k="json",y="load",x="loadend",g="loadstart",b="overrideMimeType",h="progress",m="readyState",E="responseType",S="status",L="timeout",O="type",U="up",R="withCredentials",q="xhr",j={type:l},C=[g,h,L,y,f],M=function(e){return null==e},F=(0,n.id)(function(m){return t.stream(function(e){var n=e.emit,r=e.end,t=m.url,s=m.method,o=m.user,i=m.password,u=m.headers,a=m[b],d=m.body,p=m[E],c=m[L],f=m[R],l=new XMLHttpRequest,y={xhr:l,up:j,down:j},g=function(r,t){return function(e){n(y=w.set(r,{type:t,event:e},y))}};for(var h in C.forEach(function(e){l[H](e,g(v,e)),l.upload[H](e,g(U,e))}),l[H]("readystatechange",function(e){n(y=w.set(T,e,y))}),l[H](x,function(e){r(n(y=w.set(T,e,y)))}),l.open(M(s)?"GET":s,t,!0,M(o)?null:o,M(i)?null:i),p&&(l[E]=p)===k&&l[E]!==k&&(y=w.set("parse",!0,y)),c&&(l[L]=c),f&&(l[R]=f),u)l.setRequestHeader(h,u[h]);return a&&l[b](a),l.send(M(d)?null:d),function(){l[S]||l.abort()}})}),P=w.get([w.array(w.cross([w.reread(p),w.identity])),w.inverse(w.keyed)]),A=(0,n.id)(w.transform(w.ifElse(n.isString,w.modifyOp(function(e){return{url:e,headers:n.object0}}),w.branch({headers:w.cond([M,w.setOp(n.object0)],[n.isArray,w.modifyOp(P)],[function(e){return n.isFunction(e.keys)},w.modifyOp(n.pipe2U(Array.from,P))],[[w.keys,w.modifyOp(p)]])})))),I=c(n.pipe2U(A,d(F))),X=n.curry(function(e,r){return e.includes(r)}),D=n.curry(function(e,r){return w.get([r,O,X(e)])}),J=D(C),K=D([h,g]),N=D([y]),_=D([f]),G=D([L]),W=D([y,f,L]),z=n.curry(function(e,r,t){return r([t,T,e])}),B=z("loaded",w.sum),Q=z("total",w.sum),V=z(f),Y=function(e){return 200<=e&&e<300},Z=n.curryN(3,function(e,r){return n.pipe2U(a(e),r)}),$=w.branches(v,U),ee=c(J(U)),re=c(K(U)),te=c(N(U)),ne=c(_(U)),se=c(G(U)),oe=c(W(U)),ie=c(B(U)),ue=c(Q(U)),ae=c(V(w.get,U)),de=c(J(v)),pe=c(K(v)),ce=c(N(v)),fe=c(_(v)),le=c(G(v)),ye=c(W(v)),ge=c(B(v)),he=c(Q(v)),me=c(V(w.get,v)),we=c(w.get([q,m])),He=c(w.get([q,m,function(e){return 2<=e}])),ve=c(D([x],T)),Te=c(K($)),ke=c(_($)),xe=c(G($)),be=c(B($)),Ee=c(Q($)),Se=c(n.pipe2U(V(w.collect,$),u)),Le=c(n.pipe2U(r.lift(function(e){var r=e.xhr.response;return e.parse?function(e){try{return k.parse(e)}catch(e){return null}}(r):r}),u)),Oe=c(Z(ce,Le)),Ue=c(w.get([q,E])),Re=c(Z(He,w.get([q,"responseURL"]))),qe=c(w.get([q,w.when(w.get([E,X(["","text"])])),"responseText"])),je=c(Z(ce,w.get([q,w.when(w.get([E,X(["","document"])])),"responseXML"]))),Ce=c(Z(He,w.get([q,S]))),Me=c(w.get([q,S,Y])),Fe=c(Z(He,w.get([q,"statusText"]))),Pe=n.curryN(2,function(r){return Z(He,w.get([q,w.reread(function(e){return e.getResponseHeader(r)})]))}),Ae=c(Z(He,w.get([q,w.reread(function(e){return e.getAllResponseHeaders()})]))),Ie=c(w.get([q,L])),Xe=c(w.get([q,R])),De=r.lift(Y),Je=r.lift(function(e,r){var t=n.assign({},e.headers,r.headers);return n.assign({},e,r,{headers:t})}),Ke=n.curry(function(e,r){return I(Je(A(e),A(r)))}),Ne=c(Ke({responseType:k,headers:{"Content-Type":"application/json"}})),_e=[O,X([l,y])],Ge=c(w.and(w.branch({event:[O,w.is(x)],up:_e,down:_e,xhr:[S,Y]}))),We=c(n.pipe2U(Ne,d(function(e){return Ge(e)?t.constant(Oe(e)):ve(e)&&(ke(e)||xe(e))?t.constantError(e):i}))),ze=function(e){return e},Be=ze(ce),Qe=ze(He),Ve=ze(te);e.perform=I,e.upHasStarted=ee,e.upIsProgressing=re,e.upHasCompleted=te,e.upHasFailed=ne,e.upHasTimedOut=se,e.upHasEnded=oe,e.upLoaded=ie,e.upTotal=ue,e.upError=ae,e.downHasStarted=de,e.downIsProgressing=pe,e.downHasCompleted=ce,e.downHasFailed=fe,e.downHasTimedOut=le,e.downHasEnded=ye,e.downLoaded=ge,e.downTotal=he,e.downError=me,e.readyState=we,e.isStatusAvailable=He,e.isDone=ve,e.isProgressing=Te,e.hasFailed=ke,e.hasTimedOut=xe,e.loaded=be,e.total=Ee,e.errors=Se,e.response=Le,e.responseFull=Oe,e.responseType=Ue,e.responseURL=Re,e.responseText=qe,e.responseXML=je,e.status=Ce,e.statusIsHttpSuccess=Me,e.statusText=Fe,e.responseHeader=Pe,e.allResponseHeaders=Ae,e.timeout=Ie,e.withCredentials=Xe,e.isHttpSuccess=De,e.performWith=Ke,e.performJson=Ne,e.hasSucceeded=Ge,e.getJson=We,e.downHasSucceeded=Be,e.headersReceived=Qe,e.upHasSucceeded=Ve,Object.defineProperty(e,"__esModule",{value:!0})});
