!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("karet.lift"),require("infestines"),require("kefir"),require("kefir.partial.lenses")):"function"==typeof define&&define.amd?define(["exports","karet.lift","infestines","kefir","kefir.partial.lenses","partial.lenses.validation"],r):r((e.karet=e.karet||{},e.karet.xhr={}),e.karet.lift,e.I,e.Kefir,e.Kefir.partial.lenses)}(this,function(e,r,w,t,H,n){"use strict";function v(e){try{return JSON.parse(e)}catch(e){return null}}var s=function(e){return e instanceof t.Observable},o=function(e){return s(e)?e:t.constant(e)},u=function(e){return e instanceof t.Stream?e.toProperty():e},i=t.never(),a=w.curry(function(e,r){return s(r)?r.skipDuplicates(e):r})(w.acyclicEqualsU),d=w.curry(function(e,r){if(s(r))return r.filter(e);if(e(r))return r;throw Error(e.name)}),p=w.curry(function(e,r){return s(r)?u(r.flatMapLatest(w.pipe2U(e,o))):u(e(r))}),c=function(e){return e.toLowerCase()},f=function(e){return e},T="addEventListener",k="down",l="error",x="event",y="initial",S="json",b="load",E="loadend",g="loadstart",O="overrideMimeType",U="progress",h="readyState",L="responseType",R="status",q="timeout",m="type",j="up",C="withCredentials",M="xhr",F=w.freeze({type:y}),P=w.freeze({type:E}),A=w.freeze({type:b}),I=[g,U,q,b,l],z=function(e){return null==e},J=(0,w.id)(function(m){return t.stream(function(e){var n=e.emit,r=e.end,t=m.url,s=m.method,o=m.user,u=m.password,i=m.headers,a=m[O],d=m.body,p=m[L],c=m[q],f=m[C],l=new XMLHttpRequest,y={xhr:l,up:F,down:F,map:w.id},g=function(r,t){return function(e){t===U&&y[r].type===b||n(y=H.set(r,{type:t,event:e},y))}};for(var h in I.forEach(function(e){l[T](e,g(k,e)),l.upload[T](e,g(j,e))}),l[T]("readystatechange",function(e){n(y=H.set(x,e,y))}),l[T](E,function(e){r(n(y=H.set(x,e,y)))}),l.open(z(s)?"GET":s,t,!0,z(o)?null:o,z(u)?null:u),p&&(l[L]=p)===S&&l[L]!==S&&(y=H.set("map",v,y)),c&&(l[q]=c),f&&(l[C]=f),i)l.setRequestHeader(h,i[h]);return a&&l[O](a),l.send(z(d)?null:d),function(){l[R]||l.abort()}})}),N=H.get([H.array(H.cross([H.reread(c),H.identity])),H.inverse(H.keyed)]),X=(0,w.id)(H.transform(H.ifElse(w.isString,H.modifyOp(function(e){return{url:e,headers:w.object0}}),H.branch({headers:H.cond([z,H.setOp(w.object0)],[w.isArray,H.modifyOp(N)],[function(e){return w.isFunction(e.keys)},H.modifyOp(w.pipe2U(Array.from,N))],[[H.keys,H.modifyOp(c)]])})))),D=f(w.pipe2U(X,p(J))),K=w.curry(function(e,r){return e.includes(r)}),_=w.curry(function(e,r){return H.get([r,m,K(e)])}),G=_(I),W=_([U,g]),B=_([b]),Q=_([l]),V=_([q]),Y=_([b,l,q]),Z=w.curry(function(e,r,t){return r([t,x,e])}),$=Z("loaded",H.sum),ee=Z("total",H.sum),re=Z(l),te=function(e){return 200<=e&&e<300},ne=w.curryN(3,function(e,r){return w.pipe2U(d(e),r)}),se=H.branches(k,j),oe=f(G(j)),ue=f(W(j)),ie=f(B(j)),ae=f(Q(j)),de=f(V(j)),pe=f(Y(j)),ce=f($(j)),fe=f(ee(j)),le=f(re(H.get,j)),ye=f(G(k)),ge=f(W(k)),he=f(B(k)),me=f(Q(k)),we=f(V(k)),He=f(Y(k)),ve=f($(k)),Te=f(ee(k)),ke=f(re(H.get,k)),xe=f(H.get([M,h])),Se=f(H.get([M,h,function(e){return 2<=e}])),be=f(_([E],x)),Ee=f(W(se)),Oe=f(Q(se)),Ue=f(V(se)),Le=f($(se)),Re=f(ee(se)),qe=f(w.pipe2U(re(H.collect,se),a)),je=f(ne(he,w.pipe2U(r.lift(function(e){return(0,e.map)(e.xhr.response)}),a))),Ce=f(H.get([M,L])),Me=f(ne(Se,H.get([M,"responseURL"]))),Fe=f(H.get([M,H.when(H.get([L,K(["","text"])])),"responseText"])),Pe=f(ne(he,H.get([M,H.when(H.get([L,K(["","document"])])),"responseXML"]))),Ae=f(ne(Se,H.get([M,R]))),Ie=f(H.get([M,R,te])),ze=f(ne(Se,H.get([M,"statusText"]))),Je=w.curryN(2,function(r){return ne(Se,H.get([M,H.reread(function(e){return e.getResponseHeader(r)})]))}),Ne=f(ne(Se,H.get([M,H.reread(function(e){return e.getAllResponseHeaders()})]))),Xe=f(H.get([M,q])),De=f(H.get([M,C])),Ke=r.lift(te),_e=r.lift(function(e,r){var t=w.assign({},e.headers,r.headers);return w.assign({},e,r,{headers:t})}),Ge=w.curry(function(e,r){return D(_e(X(e),X(r)))}),We=f(Ge({responseType:S,headers:{"Content-Type":"application/json"}})),Be=[m,K([y,b])],Qe=f(H.and(H.branch({event:[m,H.is(E)],up:Be,down:Be,xhr:[R,te]}))),Ve=f(w.pipe2U(We,p(function(e){return Qe(e)?je(e):be(e)&&(Oe(e)||Ue(e))?t.constantError(e):i}))),Ye=f(ne(Qe,je)),Ze=function(e){return{event:P,up:F,down:A,xhr:{status:200,response:e},map:w.id}},$e=w.curry(function(r,e){return p(function(e){return Qe(e)?r(je(e)):e},e)}),er=w.curry(function(e,r){return $e(w.pipe2U(e,Ze),r)}),rr=w.curry(function(e,r){return $e(function(e){return er(e,r)},e)}),tr=function(e){return e},nr=tr(he),sr=tr(Se),or=tr(je),ur=tr(ie);e.perform=D,e.upHasStarted=oe,e.upIsProgressing=ue,e.upHasCompleted=ie,e.upHasFailed=ae,e.upHasTimedOut=de,e.upHasEnded=pe,e.upLoaded=ce,e.upTotal=fe,e.upError=le,e.downHasStarted=ye,e.downIsProgressing=ge,e.downHasCompleted=he,e.downHasFailed=me,e.downHasTimedOut=we,e.downHasEnded=He,e.downLoaded=ve,e.downTotal=Te,e.downError=ke,e.readyState=xe,e.isStatusAvailable=Se,e.isDone=be,e.isProgressing=Ee,e.hasFailed=Oe,e.hasTimedOut=Ue,e.loaded=Le,e.total=Re,e.errors=qe,e.response=je,e.responseType=Ce,e.responseURL=Me,e.responseText=Fe,e.responseXML=Pe,e.status=Ae,e.statusIsHttpSuccess=Ie,e.statusText=ze,e.responseHeader=Je,e.allResponseHeaders=Ne,e.timeout=Xe,e.withCredentials=De,e.isHttpSuccess=Ke,e.performWith=Ge,e.performJson=We,e.hasSucceeded=Qe,e.getJson=Ve,e.result=Ye,e.of=Ze,e.chain=$e,e.map=er,e.ap=rr,e.downHasSucceeded=nr,e.headersReceived=sr,e.responseFull=or,e.upHasSucceeded=ur,Object.defineProperty(e,"__esModule",{value:!0})});
